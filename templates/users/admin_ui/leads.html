<h2>Leads Management</h2>
<hr>

<!-- Leads Table -->
{% if leads %}
<table border="1" cellpadding="5">
  <tr>
    <th>Name</th>
    <th>Instagram</th>
    <th>Contact</th>
    <th>Latest Message</th>
    <th>Status</th>
    <th>Assigned To</th>
    <th>Source</th>
    <th>Created</th>
    <th>Assign</th>
    <th>Convert</th>
  </tr>
  {% for lead in leads %}
  <tr>
    <td>{{ lead.name|default:lead.instagram_username }}</td>
    <td>{{ lead.instagram_username|default:lead.insta_id }}</td>
    <td>{{ lead.contact|default:"-" }}</td>
    <td>
      {% if lead.messages %}
        {% with last_msg=lead.messages|last %}
          {{ last_msg.text|default:"-" }} <br>
          <small>{{ last_msg.created_time|default:"-" }}</small>
        {% endwith %}
      {% else %}
        -
      {% endif %}
    </td>
    <td>
      <form method="post" action="{% url 'update_lead_status' lead.id %}">
        {% csrf_token %}
        <select name="status" onchange="this.form.submit()">
          <option value="NEW" {% if lead.status == "NEW" %}selected{% endif %}>New</option>
          <option value="IN_DISCUSSION" {% if lead.status == "IN_DISCUSSION" %}selected{% endif %}>In Discussion</option>
          <option value="CONVERTED" {% if lead.status == "CONVERTED" %}selected{% endif %}>Converted</option>
          <option value="NOT_INTERESTED" {% if lead.status == "NOT_INTERESTED" %}selected{% endif %}>Not Interested</option>
        </select>
      </form>
    </td>
    <td>{{ lead.assigned_to|default:"Not Assigned" }}</td>
    <td>{{ lead.source|default:"Instagram" }}</td>
    <td>{{ lead.created_time|default:"-" }}</td>
    <td>
      <form method="post" action="{% url 'assign_lead' lead.id %}">
        {% csrf_token %}
        <select name="assigned_to">
          <option value="">-- Assign --</option>
          {% for c in counselors %}
            <option value="{{ c.username }}">{{ c.username }} (Counselor)</option>
          {% endfor %}
          {% for n in nutritionists %}
            <option value="{{ n.username }}">{{ n.username }} (Nutritionist)</option>
          {% endfor %}
        </select>
        <button type="submit">Assign</button>
      </form>
    </td>
    <td>
      {% if lead.status != "CONVERTED" %}
        <a href="{% url 'convert_lead_to_customer' lead.id %}">Convert to Customer</a>
      {% else %}
        Already Converted
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>
{% else %}
<p>No leads available yet. Instagram DMs will appear here once someone messages you.</p>
{% endif %}
